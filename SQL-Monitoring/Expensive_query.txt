WITH QueryStats AS
(
    SELECT 
        qs.sql_handle,
        qs.plan_handle,
        DB_NAME(st.dbid) AS DatabaseName,
        OBJECT_NAME(st.objectid, st.dbid) AS ObjectName,
        st.text AS QueryText,
        qs.creation_time,
        qs.execution_count,
        qs.total_worker_time / 1000 AS TotalCPUTime,
        qs.total_elapsed_time / 1000 AS TotalElapsedTime,
        qs.total_logical_reads,
        qs.total_logical_writes,
        qs.total_physical_reads,
        qs.total_logical_reads / qs.execution_count AS AvgLogicalReads,
        qs.total_worker_time / qs.execution_count / 1000 AS AvgCPUTime,
        qs.total_elapsed_time / qs.execution_count / 1000 AS AvgElapsedTime
    FROM 
        sys.dm_exec_query_stats qs
    CROSS APPLY 
        sys.dm_exec_sql_text(qs.sql_handle) st
)
SELECT 
    DatabaseName,
    ObjectName,
    QueryText,
    execution_count AS ExecutionCount,
    TotalCPUTime,
    TotalElapsedTime,
    total_logical_reads AS TotalLogicalReads,
    total_logical_writes AS TotalLogicalWrites,
    total_physical_reads AS TotalPhysicalReads,
    AvgLogicalReads,
    AvgCPUTime,
    AvgElapsedTime
FROM 
    QueryStats
ORDER BY 
    TotalCPUTime DESC;

